#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

# fail fast
set -e

# debug
# set -x

shopt -s extglob

function error() {
  echo " !     $*" >&2
  exit 1
}

function indent() {
  c='s/^/       /'
  case $(uname) in
    Darwin) sed -l "$c";;
    *)      sed -u "$c";;
  esac
}

function read_var() {
  echo $(head -n 1 $1)
}

# clean up leaking environment
unset GIT_DIR

# parse and derive params
BUILD_DIR=$1
cache_dir=$2
bp_dir=$(cd $(dirname $0); cd ..; pwd)
VENDOR_DIR=$BUILD_DIR/vendor
BUILDPACK_DIR="$(dirname $(dirname $0))"

CRAN_MIRROR="http://cran.revolutionanalytics.com"

mv $BUILD_DIR/.Renviron ~
export R_ENVIRON_USER="~/Rfiles"

# set the CRAN mirror and run the init.r program
echo "set the CRAN mirror and run the init.r program"
R -s <<RPROG > indent
  Sys.setenv(BUILD_DIR="$BUILD_DIR")
  setwd("$BUILD_DIR")
  r <- getOption("repos");
  r["CRAN"] <- "$CRAN_MIRROR";
  options(repos=r);
  `cat $BUILD_DIR/init.r`
RPROG